<!DOCTYPE html>
<html lang="en" data-theme="night" data-accent="gold">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Glasspane</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ™</text></svg>">
<style>
  /* ============================================================
     THEMES
     ============================================================ */

  /* Night (default) */
  [data-theme="night"] {
    --bg: #0c0c0e;
    --text: #d8d8dc;
    --text-dim: #8a8a92;
    --slide-bg: #16161a;
    --progress-bg: #1c1c22;
    --hint-bg: #141418;
    --hint-border: #222;
    --divider: #222;
    --pip-bg: #2a2a30;
    --pip-border: #444;
    --scroll-indicator-bg: rgba(16, 16, 20, 0.94);
    --timer-bg: rgba(12, 12, 14, 0.85);
    --settings-bg: rgba(16, 16, 20, 0.96);
    --settings-border: #333;
  }

  /* Navy */
  [data-theme="navy"] {
    --bg: #0a0f1e;
    --text: #d0d8f0;
    --text-dim: #7a84a0;
    --slide-bg: #111830;
    --progress-bg: #141a2e;
    --hint-bg: #0e1428;
    --hint-border: #1e2a48;
    --divider: #1e2a48;
    --pip-bg: #1a2240;
    --pip-border: #2e3a58;
    --scroll-indicator-bg: rgba(10, 15, 30, 0.94);
    --timer-bg: rgba(10, 15, 30, 0.85);
    --settings-bg: rgba(10, 15, 30, 0.96);
    --settings-border: #2e3a58;
  }

  /* Day */
  [data-theme="day"] {
    --bg: #f8f7f4;
    --text: #1a1a1a;
    --text-dim: #6e6e6e;
    --slide-bg: #eeedea;
    --progress-bg: #e0dfdc;
    --hint-bg: #f0efec;
    --hint-border: #d8d7d4;
    --divider: #d8d7d4;
    --pip-bg: #d0cfcc;
    --pip-border: #b0afac;
    --scroll-indicator-bg: rgba(248, 247, 244, 0.94);
    --timer-bg: rgba(248, 247, 244, 0.85);
    --settings-bg: rgba(248, 247, 244, 0.96);
    --settings-border: #b0afac;
  }

  /* Auto â€” follows system preference */
  @media (prefers-color-scheme: dark) {
    [data-theme="auto"] {
      --bg: #0c0c0e;
      --text: #d8d8dc;
      --text-dim: #8a8a92;
      --slide-bg: #16161a;
      --progress-bg: #1c1c22;
      --hint-bg: #141418;
      --hint-border: #222;
      --divider: #222;
      --pip-bg: #2a2a30;
      --pip-border: #444;
      --scroll-indicator-bg: rgba(16, 16, 20, 0.94);
      --timer-bg: rgba(12, 12, 14, 0.85);
      --settings-bg: rgba(16, 16, 20, 0.96);
      --settings-border: #333;
    }
  }
  @media (prefers-color-scheme: light) {
    [data-theme="auto"] {
      --bg: #f8f7f4;
      --text: #1a1a1a;
      --text-dim: #6e6e6e;
      --slide-bg: #eeedea;
      --progress-bg: #e0dfdc;
      --hint-bg: #f0efec;
      --hint-border: #d8d7d4;
      --divider: #d8d7d4;
      --pip-bg: #d0cfcc;
      --pip-border: #b0afac;
      --scroll-indicator-bg: rgba(248, 247, 244, 0.94);
      --timer-bg: rgba(248, 247, 244, 0.85);
      --settings-bg: rgba(248, 247, 244, 0.96);
      --settings-border: #b0afac;
    }
  }

  /* ============================================================
     ACCENTS
     ============================================================ */

  /* Gold (default) */
  [data-accent="gold"] {
    --accent: #c9a84c;
    --click: #e05a40;
    --highlight: rgba(201, 168, 76, 0.18);
    --highlight-border: #c9a84c;
    --slide-border: #c9a84c;
    --scroll-active: #4aba7a;
    --slow-color: #f0c060;
  }

  /* Teal */
  [data-accent="teal"] {
    --accent: #3dbfa8;
    --click: #e05a40;
    --highlight: rgba(61, 191, 168, 0.18);
    --highlight-border: #3dbfa8;
    --slide-border: #3dbfa8;
    --scroll-active: #4aba7a;
    --slow-color: #5dd8c0;
  }

  /* ============================================================
     RESET & BASE
     ============================================================ */

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html {
    scroll-behavior: smooth;
    scrollbar-width: thin;
    scrollbar-color: #333 var(--bg);
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    font-size: 22px;
    line-height: 1.85;
    -webkit-font-smoothing: antialiased;
    padding: 0;
  }

  /* ============================================================
     DROP ZONE â€” initial screen
     ============================================================ */

  #drop-zone {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 32px;
    gap: 32px;
  }

  .wordmark {
    font-size: 28px;
    font-weight: 600;
    letter-spacing: 0.06em;
    color: var(--text);
    text-transform: uppercase;
  }

  .wordmark-sub {
    display: block;
    font-size: 13px;
    font-weight: 400;
    letter-spacing: 0.04em;
    color: var(--text-dim);
    text-transform: none;
    margin-top: 4px;
  }

  #dropTarget {
    width: 360px;
    max-width: 90vw;
    padding: 48px 32px;
    border: 2px dashed var(--pip-border);
    border-radius: 12px;
    text-align: center;
    color: var(--text-dim);
    font-size: 15px;
    cursor: pointer;
    transition: border-color 0.15s ease, background 0.15s ease;
  }

  #dropTarget.drag-over {
    border-color: var(--accent);
    background: var(--highlight);
  }

  #dropTarget:hover {
    border-color: var(--accent);
  }

  .drop-label {
    display: block;
    cursor: pointer;
  }

  .drop-or {
    display: block;
    margin-top: 8px;
    font-size: 12px;
    color: var(--text-dim);
    opacity: 0.6;
  }

  #fileInput {
    display: none;
  }

  #demoLink {
    color: var(--accent);
    font-size: 14px;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: border-color 0.15s ease;
  }

  #demoLink:hover {
    border-bottom-color: var(--accent);
  }

  #guideLink {
    color: var(--text-dim);
    font-size: 12px;
    text-decoration: none;
    opacity: 0.7;
    transition: opacity 0.15s ease;
  }

  #guideLink:hover {
    opacity: 1;
  }

  /* ============================================================
     PROGRESS BAR
     ============================================================ */

  .progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--progress-bg);
    z-index: 100;
  }
  .progress-fill {
    height: 100%;
    background: var(--slide-border);
    width: 0%;
    transition: width 0.3s ease;
  }

  /* ============================================================
     SLIDE NAV
     ============================================================ */

  .slide-nav {
    position: fixed;
    top: 12px;
    right: 56px;
    z-index: 100;
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .slide-pip {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--pip-bg);
    border: 1.5px solid var(--pip-border);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .slide-pip.active {
    background: var(--slide-border);
    border-color: var(--slide-border);
    transform: scale(1.3);
  }
  .slide-pip:hover {
    border-color: var(--slide-border);
  }

  /* ============================================================
     CONTAINER
     ============================================================ */

  .container {
    max-width: 720px;
    margin: 0 auto;
    padding: 60px 32px 80vh;
  }

  /* ============================================================
     HINT BANNER
     ============================================================ */

  .hint {
    text-align: center;
    color: var(--text-dim);
    font-size: 13px;
    letter-spacing: 0.04em;
    margin-bottom: 48px;
    padding: 12px 16px;
    background: var(--hint-bg);
    border-radius: 8px;
    border: 1px solid var(--hint-border);
    line-height: 1.7;
  }
  .hint kbd {
    display: inline-block;
    background: var(--hint-border);
    color: var(--text-dim);
    border: 1px solid var(--pip-border);
    border-radius: 4px;
    padding: 1px 6px;
    font-family: inherit;
    font-size: 12px;
    margin: 0 2px;
  }
  .hint-divider {
    display: block;
    margin: 4px 0;
    border-top: 1px solid var(--hint-border);
  }

  /* ============================================================
     SLIDE HEADERS
     ============================================================ */

  .slide-header {
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--slide-border);
    background: var(--slide-bg);
    border-left: 3px solid var(--slide-border);
    padding: 14px 20px;
    margin: 64px 0 32px;
    border-radius: 0 6px 6px 0;
  }
  .slide-header:first-of-type {
    margin-top: 0;
  }

  /* ============================================================
     PARAGRAPHS (clickable)
     ============================================================ */

  .line {
    padding: 8px 16px;
    margin: 4px 0;
    border-left: 3px solid transparent;
    border-radius: 0 4px 4px 0;
    cursor: pointer;
    transition: background 0.15s ease, border-color 0.15s ease;
  }
  .line:hover {
    background: rgba(255,255,255,0.02);
  }
  .line.active {
    background: var(--highlight);
    border-left-color: var(--highlight-border);
  }

  /* ============================================================
     STAGE DIRECTIONS
     ============================================================ */

  .d {
    color: var(--accent);
    font-size: 15px;
    font-weight: 500;
    opacity: 0.85;
    white-space: nowrap;
  }
  .d-click {
    display: inline-block;
    background: var(--click);
    color: #fff;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.08em;
    padding: 2px 10px;
    border-radius: 4px;
    margin: 16px 0 8px;
  }
  .d-pause {
    display: block;
    color: var(--text-dim);
    font-size: 14px;
    font-style: italic;
    padding: 6px 0;
    margin: 4px 0;
  }
  .d-note {
    font-size: 14px;
    color: var(--text-dim);
    font-style: italic;
  }

  /* ============================================================
     EMPHASIS IN SPOKEN TEXT
     ============================================================ */

  .slow {
    color: var(--slow-color);
    font-weight: 500;
  }

  /* ============================================================
     DIVIDER BETWEEN SLIDES
     ============================================================ */

  .slide-divider {
    border: none;
    border-top: 1px solid var(--divider);
    margin: 48px 0 16px;
  }

  /* ============================================================
     TIMER (top-left)
     ============================================================ */

  .timer {
    position: fixed;
    top: 10px;
    left: 20px;
    z-index: 100;
    font-size: 16px;
    font-variant-numeric: tabular-nums;
    color: var(--text-dim);
    font-weight: 500;
    cursor: pointer;
    user-select: none;
    background: var(--timer-bg);
    padding: 4px 12px;
    border-radius: 6px;
    backdrop-filter: blur(8px);
    border: 1px solid var(--hint-border);
  }
  .timer.running {
    color: var(--accent);
  }
  .timer-label {
    font-size: 11px;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    opacity: 0.6;
    margin-right: 6px;
  }

  /* ============================================================
     AUTO-SCROLL INDICATOR
     ============================================================ */

  .scroll-indicator {
    position: fixed;
    bottom: 28px;
    left: 50%;
    transform: translateX(-50%) translateY(70px);
    z-index: 200;
    background: var(--scroll-indicator-bg);
    border: 1.5px solid var(--scroll-active);
    border-radius: 10px;
    padding: 10px 24px;
    display: flex;
    align-items: center;
    gap: 14px;
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.03em;
    color: var(--scroll-active);
    backdrop-filter: blur(12px);
    opacity: 0;
    transition: opacity 0.15s ease, transform 0.15s ease;
    pointer-events: none;
    user-select: none;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  }
  .scroll-indicator.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  .scroll-indicator .scroll-label {
    font-size: 11px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .scroll-indicator .scroll-dots {
    display: flex;
    gap: 5px;
    align-items: center;
  }
  .scroll-indicator .dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: var(--pip-bg);
    border: 1px solid var(--pip-border);
    transition: background 0.1s ease, border-color 0.1s ease;
  }
  .scroll-indicator .dot.filled {
    background: var(--scroll-active);
    border-color: var(--scroll-active);
  }
  .scroll-indicator .scroll-speed-name {
    min-width: 64px;
    text-align: center;
    font-variant-numeric: tabular-nums;
  }
  .scroll-indicator .scroll-hint {
    font-size: 11px;
    color: var(--text-dim);
    opacity: 0.7;
  }

  /* ============================================================
     SCROLL-ACTIVE BORDER GLOW
     ============================================================ */

  .scroll-border-glow {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--scroll-active);
    z-index: 99;
    opacity: 0;
    transition: opacity 0.15s ease;
  }
  .scroll-border-glow.visible {
    opacity: 1;
  }

  /* ============================================================
     SETTINGS BUTTON & PANEL
     ============================================================ */

  .settings-btn {
    position: fixed;
    top: 8px;
    right: 16px;
    z-index: 110;
    width: 32px;
    height: 32px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-size: 18px;
    cursor: pointer;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.15s ease, background 0.15s ease;
  }
  .settings-btn:hover {
    color: var(--text);
    background: var(--hint-bg);
  }

  .settings-panel {
    display: none;
    position: fixed;
    top: 44px;
    right: 16px;
    z-index: 110;
    background: var(--settings-bg);
    border: 1px solid var(--settings-border);
    border-radius: 10px;
    padding: 20px 24px;
    backdrop-filter: blur(16px);
    min-width: 200px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
  }
  .settings-panel.visible {
    display: block;
  }

  .settings-group {
    margin-bottom: 16px;
  }
  .settings-group:last-child {
    margin-bottom: 0;
  }
  .settings-group-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 8px;
  }
  .settings-group label {
    display: block;
    font-size: 14px;
    color: var(--text);
    cursor: pointer;
    padding: 3px 0;
  }
  .settings-group label input[type="radio"] {
    margin-right: 8px;
    accent-color: var(--accent);
  }

  .settings-panel button {
    width: 100%;
    margin-top: 12px;
    padding: 8px 16px;
    font-size: 13px;
    font-weight: 500;
    color: var(--text);
    background: var(--hint-bg);
    border: 1px solid var(--hint-border);
    border-radius: 6px;
    cursor: pointer;
    transition: border-color 0.15s ease;
  }
  .settings-panel button:hover {
    border-color: var(--accent);
  }

  /* ============================================================
     PRINT
     ============================================================ */

  @media print {
    body { background: #fff; color: #111; font-size: 14px; line-height: 1.6; }
    .progress-bar, .slide-nav, .timer, .hint, .scroll-indicator, .scroll-border-glow, .settings-btn, .settings-panel, #drop-zone { display: none; }
    .container { max-width: 100%; padding: 20px; }
    .slide-header { background: #f5f5f5; color: #333; border-left-color: #333; }
    .line { border-left: none; padding: 2px 0; }
    .d { color: #888; }
    .d-click { background: #666; }
  }
</style>
</head>
<body data-script-id="">

<!-- ============================================================
     DROP ZONE â€” initial screen
     ============================================================ -->
<div id="drop-zone">
  <div class="wordmark">
    Glasspane
    <span class="wordmark-sub">Browser teleprompter</span>
  </div>

  <label class="drop-label" for="fileInput">
    <div id="dropTarget">
      Drop a .md script here
      <span class="drop-or">or click to browse</span>
    </div>
  </label>
  <input type="file" id="fileInput" accept=".md,text/markdown">

  <a href="#" id="demoLink">Try the demo</a>
  <a href="/guide" target="_blank" rel="noopener" id="guideLink">How to write a script â†’</a>
</div>

<!-- ============================================================
     TELEPROMPTER â€” hidden until a script is loaded
     ============================================================ -->
<div id="teleprompter" style="display: none">

  <!-- Progress bar -->
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>

  <!-- Green glow bar under progress bar when auto-scrolling -->
  <div class="scroll-border-glow" id="scrollGlow"></div>

  <!-- Timer -->
  <div class="timer" id="timer" title="Click to start/stop">
    <span class="timer-label">Timer</span>
    <span id="timerDisplay">00:00</span>
  </div>

  <!-- Slide navigation pips (populated dynamically) -->
  <div class="slide-nav" id="slideNav"></div>

  <!-- Settings button -->
  <button class="settings-btn" id="settingsBtn" title="Settings" aria-label="Settings">&#9881;</button>

  <!-- Settings panel -->
  <div class="settings-panel" id="settingsPanel">
    <div class="settings-group">
      <div class="settings-group-label">Theme</div>
      <label><input type="radio" name="theme" value="night"> Night</label>
      <label><input type="radio" name="theme" value="navy"> Navy</label>
      <label><input type="radio" name="theme" value="day"> Day</label>
      <label><input type="radio" name="theme" value="auto"> Auto</label>
    </div>
    <div class="settings-group">
      <div class="settings-group-label">Accent</div>
      <label><input type="radio" name="accent" value="gold"> Gold</label>
      <label><input type="radio" name="accent" value="teal"> Teal</label>
    </div>
    <button id="loadNewBtn">Load new script</button>
  </div>

  <!-- Auto-scroll indicator -->
  <div class="scroll-indicator" id="scrollIndicator">
    <span class="scroll-label">Auto &#9654;</span>
    <span class="scroll-dots" id="scrollDots">
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
      <span class="dot"></span>
    </span>
    <span class="scroll-speed-name" id="scrollSpeedName">3</span>
    <span class="scroll-hint">&#8593;&#8595; speed &middot; click to stop</span>
  </div>

  <!-- Main content -->
  <div class="container" id="mainContainer">
    <div class="hint">
      <kbd>&#8595;</kbd> start auto-scroll &nbsp;&middot;&nbsp; click anywhere to stop &nbsp;&middot;&nbsp; <kbd>&#8593;</kbd><kbd>&#8595;</kbd> adjust speed while scrolling
      <span class="hint-divider"></span>
      <kbd>j</kbd><kbd>k</kbd> move highlight &nbsp;&middot;&nbsp; Click paragraph to mark place &nbsp;&middot;&nbsp; Click timer to start/stop
    </div>
    <div id="scriptContent"></div>
  </div>

</div>

<!-- Build step replaces this with an inline version for dist/ -->
<script src="node_modules/dompurify/dist/purify.min.js"></script>

<script>
(function() {
  'use strict';

  // ============================================================
  // PARSER â€” copied verbatim from src/parser.js
  // ============================================================

  /**
   * parseScript
   * @param {string} text - raw .md file content
   * @returns {{ title: string, blocks: Array }[]}
   */
  function parseScript(text) {
    const lines = text.split('\n');
    const slides = [];
    let current = { title: '', blocks: [] };

    for (const raw of lines) {
      const line = raw.trim();

      if (!line || line === '---') continue;

      // Slide boundary
      if (line.startsWith('## ')) {
        if (current.blocks.length > 0 || current.title) {
          slides.push(current);
        }
        current = { title: line.slice(3).trim(), blocks: [] };
        continue;
      }

      // Block-level cue: line is *only* [TAG optional note]
      // The tag must begin with an uppercase word. After the all-caps keyword(s)
      // the rest is free-form note text (may include lowercase, punctuation, etc.).
      const blockMatch = line.match(/^\[([A-Z][A-Z ]*(?:[\u2014\-.,!?\s].*)?)\]$/);
      if (blockMatch) {
        const tag = blockMatch[1].trim();
        if (tag === 'CLICK') {
          current.blocks.push({ type: 'click' });
        } else if (tag.startsWith('NOTE')) {
          current.blocks.push({ type: 'note', text: tag.slice(4).trim() });
        } else {
          // PAUSE, LOOK UP, SMILE, and any other all-caps cue
          const spaceIdx = tag.indexOf(' ');
          const note = spaceIdx >= 0 ? tag.slice(spaceIdx).trim() : '';
          current.blocks.push({ type: 'pause', note });
        }
        continue;
      }

      // Spoken line â€” process inline markup
      current.blocks.push({ type: 'line', html: processInline(line) });
    }

    slides.push(current);
    return slides;
  }

  /**
   * processInline â€” converts a plain text line to safe HTML.
   * Escapes HTML entities first, then applies markup.
   * The result must still pass through DOMPurify before DOM insertion.
   * @param {string} text
   * @returns {string}
   */
  function processInline(text) {
    // 1. Escape HTML entities to prevent injection
    let html = text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');

    // 2. **bold** â†’ slow emphasis span
    html = html.replace(/\*\*(.+?)\*\*/g, '<span class="slow">$1</span>');

    // 3. [ALL CAPS] inline direction â€” only matches all-caps content
    html = html.replace(/\[([A-Z][A-Z ]*(?:[\u2014\-.,!?\s].*)?)\]/g, '<span class="d">[$1]</span>');

    return html;
  }

  // ============================================================
  // TELEPROMPTER STATE (outer scope so loadNewBtn can reach them)
  // ============================================================

  var teleprompterInited = false;

  // Mutable DOM collections â€” refreshed on each script load
  var tpLines = [];
  var tpSections = [];
  var tpPips = [];

  // Highlight
  var activeIndex = -1;

  // Timer
  var timerRunning = false;
  var timerStart = 0;
  var timerInterval = null;

  // Auto-scroll
  var scrollActive = false;
  var scrollLevel = 3; // 1-7, default 3
  var scrollRAF = null;
  var lastFrameTime = null;
  var scrollAccumulator = 0;

  var SPEED_LEVELS = [
    { px: 12,  name: '1' },
    { px: 18,  name: '2' },
    { px: 27,  name: '3' },
    { px: 40,  name: '4' },
    { px: 60,  name: '5' },
    { px: 90,  name: '6' },
    { px: 135, name: '7' },
  ];

  // IntersectionObserver instance â€” disconnected and recreated per script load
  var slideObserver = null;

  // Forward-declared functions (assigned in initTeleprompter)
  var stopScroll;
  var startScroll;
  var changeSpeed;
  var setActive;

  // ============================================================
  // RENDERER
  // ============================================================

  function renderScript(slides) {
    var frag = document.createDocumentFragment();

    slides.forEach(function(slide, slideIndex) {
      // Divider before non-first slides
      if (slideIndex > 0) {
        var hr = document.createElement('hr');
        hr.className = 'slide-divider';
        frag.appendChild(hr);
      }

      var section = document.createElement('div');
      section.className = 'slide-section';
      section.id = 'slide-' + slideIndex;

      // Slide header
      if (slide.title) {
        var header = document.createElement('div');
        header.className = 'slide-header';
        header.textContent = slide.title;
        section.appendChild(header);
      }

      // Blocks
      slide.blocks.forEach(function(block) {
        var el = document.createElement('div');
        if (block.type === 'click') {
          el.className = 'd-click';
          el.textContent = 'CLICK';
        } else if (block.type === 'pause') {
          el.className = 'd-pause';
          el.textContent = '[PAUSE' + (block.note ? ' ' + block.note : '') + ']';
        } else if (block.type === 'note') {
          el.className = 'd-note';
          el.textContent = '[NOTE' + (block.text ? ' ' + block.text : '') + ']';
        } else if (block.type === 'line') {
          el.className = 'line';
          // DOMPurify sanitises the pre-processed HTML before DOM insertion
          var clean = DOMPurify.sanitize(block.html, {
            ALLOWED_TAGS: ['span'],
            ALLOWED_ATTR: ['class']
          });
          el.appendChild(createSanitisedFragment(clean));
        }
        section.appendChild(el);
      });

      frag.appendChild(section);
    });

    // Replace content atomically
    var scriptContent = document.getElementById('scriptContent');
    while (scriptContent.firstChild) {
      scriptContent.removeChild(scriptContent.firstChild);
    }
    scriptContent.appendChild(frag);

    // Populate slide pips
    var slideNav = document.getElementById('slideNav');
    while (slideNav.firstChild) {
      slideNav.removeChild(slideNav.firstChild);
    }
    slides.forEach(function(slide, index) {
      var pip = document.createElement('div');
      pip.className = 'slide-pip';
      pip.dataset.slide = index;
      pip.title = slide.title || ('Slide ' + (index + 1));
      slideNav.appendChild(pip);
    });
  }

  /**
   * createSanitisedFragment â€” converts a DOMPurify-sanitised HTML string
   * into a DocumentFragment for safe insertion.
   */
  function createSanitisedFragment(sanitisedHtml) {
    var template = document.createElement('template');
    template.innerHTML = sanitisedHtml;
    return template.content;
  }

  // ============================================================
  // SCRIPT LOADING
  // ============================================================

  function loadScript(text) {
    var slides = parseScript(text);
    renderScript(slides);
    document.getElementById('drop-zone').style.display = 'none';
    document.getElementById('fileInput').disabled = true;
    document.getElementById('teleprompter').style.display = '';
    window.scrollTo(0, 0);

    if (!teleprompterInited) {
      initTeleprompter();
      teleprompterInited = true;
    } else {
      refreshTeleprompter();
    }
  }

  function handleFile(file) {
    var reader = new FileReader();
    reader.onload = function() {
      loadScript(reader.result);
    };
    reader.onerror = function() { alert('Could not read file.'); };
    reader.readAsText(file);
  }

  // Drag and drop
  var dropTarget = document.getElementById('dropTarget');

  dropTarget.addEventListener('dragover', function(e) {
    e.preventDefault();
    dropTarget.classList.add('drag-over');
  });

  dropTarget.addEventListener('dragleave', function() {
    dropTarget.classList.remove('drag-over');
  });

  dropTarget.addEventListener('drop', function(e) {
    e.preventDefault();
    dropTarget.classList.remove('drag-over');
    var files = e.dataTransfer.files;
    if (files.length > 0) {
      handleFile(files[0]);
    }
  });

  // File input fallback
  document.getElementById('fileInput').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
      handleFile(e.target.files[0]);
    }
  });

  // Demo link
  document.getElementById('demoLink').addEventListener('click', function(e) {
    e.preventDefault();
    fetch('./scripts/jfk-inaugural.md')
      .then(function(r) {
        if (!r.ok) throw new Error('Demo script not found (' + r.status + ')');
        return r.text();
      })
      .then(function(text) { loadScript(text); })
      .catch(function(err) { alert('Could not load demo: ' + err.message); });
  });

  // Load new script button
  document.getElementById('loadNewBtn').addEventListener('click', function() {
    // Stop auto-scroll if active
    if (scrollActive && stopScroll) stopScroll();
    // Stop timer if running
    if (timerRunning) {
      clearInterval(timerInterval);
      timerInterval = null;
      timerRunning = false;
    }

    document.getElementById('teleprompter').style.display = 'none';
    document.getElementById('drop-zone').style.display = '';
    document.getElementById('fileInput').disabled = false;
    var scriptContent = document.getElementById('scriptContent');
    while (scriptContent.firstChild) {
      scriptContent.removeChild(scriptContent.firstChild);
    }
    var slideNav = document.getElementById('slideNav');
    while (slideNav.firstChild) {
      slideNav.removeChild(slideNav.firstChild);
    }
    document.getElementById('settingsPanel').classList.remove('visible');
    // Reset progress
    document.getElementById('progressFill').style.width = '0%';
    // Reset timer display
    document.getElementById('timerDisplay').textContent = '00:00';
    document.getElementById('timer').classList.remove('running');
  });

  // On page load: check for shared script ID
  var scriptId = document.body.dataset.scriptId;
  if (scriptId) {
    fetch('/script/' + scriptId)
      .then(function(r) {
        if (!r.ok) throw new Error('Script not found');
        return r.text();
      })
      .then(function(text) { loadScript(text); })
      .catch(function() {
        var dropTarget = document.getElementById('dropTarget');
        var errMsg = document.createElement('div');
        errMsg.style.cssText = 'color: var(--click); margin-top: 12px; font-size: 14px;';
        errMsg.textContent = 'The shared script could not be found. It may have expired or been removed.';
        dropTarget.parentNode.insertBefore(errMsg, dropTarget.nextSibling);
      });
  }

  // ============================================================
  // TELEPROMPTER INTERACTIONS
  // (Adapted from psd3-teleprompter.html â€” re-queries DOM after render)
  // ============================================================

  /**
   * refreshTeleprompter â€” re-queries DOM collections that change on each
   * script load (lines, sections, pips) and reconnects the
   * IntersectionObserver. Resets highlight and scroll state.
   */
  function refreshTeleprompter() {
    tpLines = document.querySelectorAll('.line');
    tpSections = document.querySelectorAll('.slide-section');
    tpPips = document.querySelectorAll('.slide-pip');

    // Reset state
    activeIndex = -1;
    if (scrollActive && stopScroll) stopScroll();

    // Reconnect IntersectionObserver for new sections
    if (slideObserver) slideObserver.disconnect();
    slideObserver = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (entry.isIntersecting) {
          var slideId = entry.target.id;
          tpPips.forEach(function(p) {
            p.classList.toggle('active', 'slide-' + p.dataset.slide === slideId);
          });
        }
      });
    }, { threshold: 0.3 });
    tpSections.forEach(function(s) { slideObserver.observe(s); });

    // Re-attach pip click listeners (pips are new DOM elements)
    tpPips.forEach(function(pip) {
      pip.addEventListener('click', function(e) {
        e.stopPropagation();
        if (scrollActive) stopScroll();
        var section = document.getElementById('slide-' + pip.dataset.slide);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
          var firstLine = section.querySelector('.line');
          if (firstLine) {
            var idx = Array.from(tpLines).indexOf(firstLine);
            if (idx >= 0) setActive(idx);
          }
        }
      });
    });
  }

  /**
   * initTeleprompter â€” called exactly once on the first script load.
   * Registers all global event listeners and performs the initial
   * DOM query via refreshTeleprompter().
   */
  function initTeleprompter() {
    var htmlEl = document.documentElement;
    var timerEl = document.getElementById('timer');
    var timerDisplay = document.getElementById('timerDisplay');
    var progressFill = document.getElementById('progressFill');
    var scrollIndicator = document.getElementById('scrollIndicator');
    var scrollDots = document.querySelectorAll('#scrollDots .dot');
    var scrollSpeedName = document.getElementById('scrollSpeedName');
    var scrollGlow = document.getElementById('scrollGlow');
    var mainContainer = document.getElementById('mainContainer');

    // HIGHLIGHT
    setActive = function(index) {
      tpLines.forEach(function(l) { l.classList.remove('active'); });
      if (index >= 0 && index < tpLines.length) {
        activeIndex = index;
        tpLines[index].classList.add('active');
        updateProgress();
        updateSlidePips();
      }
    };

    function updateProgress() {
      var pct = ((activeIndex + 1) / tpLines.length) * 100;
      progressFill.style.width = pct + '%';
    }

    function updateSlidePips() {
      if (activeIndex < 0) return;
      var section = tpLines[activeIndex].closest('.slide-section');
      if (!section) return;
      var slideId = section.id;
      tpPips.forEach(function(p) {
        p.classList.toggle('active', 'slide-' + p.dataset.slide === slideId);
      });
    }

    // AUTO-SCROLL
    function updateSpeedDisplay() {
      scrollDots.forEach(function(dot, i) {
        dot.classList.toggle('filled', i < scrollLevel);
      });
      scrollSpeedName.textContent = SPEED_LEVELS[scrollLevel - 1].name;
    }

    startScroll = function() {
      if (scrollActive) return;
      scrollActive = true;
      lastFrameTime = null;
      scrollAccumulator = 0;
      htmlEl.style.scrollBehavior = 'auto';
      scrollIndicator.classList.add('visible');
      scrollGlow.classList.add('visible');
      updateSpeedDisplay();
      scrollRAF = requestAnimationFrame(scrollTick);
    };

    stopScroll = function() {
      if (!scrollActive) return;
      scrollActive = false;
      htmlEl.style.scrollBehavior = 'smooth';
      scrollIndicator.classList.remove('visible');
      scrollGlow.classList.remove('visible');
      if (scrollRAF) {
        cancelAnimationFrame(scrollRAF);
        scrollRAF = null;
      }
      lastFrameTime = null;
    };

    function scrollTick(timestamp) {
      if (!scrollActive) return;

      if (lastFrameTime === null) {
        lastFrameTime = timestamp;
        scrollRAF = requestAnimationFrame(scrollTick);
        return;
      }

      var delta = (timestamp - lastFrameTime) / 1000;
      lastFrameTime = timestamp;

      var clampedDelta = Math.min(delta, 0.1);

      var maxScroll = document.documentElement.scrollHeight - window.innerHeight;
      if (window.scrollY >= maxScroll - 1) {
        stopScroll();
        return;
      }

      var speed = SPEED_LEVELS[scrollLevel - 1].px;
      scrollAccumulator += speed * clampedDelta;

      var pixels = Math.floor(scrollAccumulator);
      if (pixels > 0) {
        scrollAccumulator -= pixels;
        window.scrollBy(0, pixels);
      }

      scrollRAF = requestAnimationFrame(scrollTick);
    }

    changeSpeed = function(delta) {
      var newLevel = scrollLevel + delta;
      if (newLevel < 1 || newLevel > SPEED_LEVELS.length) return;
      scrollLevel = newLevel;
      updateSpeedDisplay();
    };

    // KEYBOARD (registered once)
    document.addEventListener('keydown', function(e) {
      // Only respond when teleprompter is visible
      if (document.getElementById('teleprompter').style.display === 'none') return;

      if (e.key === 'Escape') {
        if (scrollActive) {
          e.preventDefault();
          stopScroll();
        }
        var panel = document.getElementById('settingsPanel');
        if (panel.classList.contains('visible')) {
          panel.classList.remove('visible');
        }
        return;
      }

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (!scrollActive) {
          startScroll();
        } else {
          changeSpeed(1);
        }
        return;
      }

      if (e.key === 'ArrowUp') {
        e.preventDefault();
        if (scrollActive) {
          changeSpeed(-1);
        }
        return;
      }

      if (e.key === 'j') {
        e.preventDefault();
        var next = Math.min(activeIndex + 1, tpLines.length - 1);
        setActive(next);
        if (!scrollActive) {
          tpLines[next].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }
      if (e.key === 'k') {
        e.preventDefault();
        var prev = Math.max(activeIndex - 1, 0);
        setActive(prev);
        if (!scrollActive) {
          tpLines[prev].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return;
      }
    });

    // CLICK â€” stop scroll OR highlight paragraph (registered once on mainContainer)
    mainContainer.addEventListener('click', function(e) {
      if (scrollActive) {
        stopScroll();
        return;
      }

      var line = e.target.closest('.line');
      if (line) {
        var idx = Array.from(tpLines).indexOf(line);
        if (idx >= 0) setActive(idx);
      }
    });

    // Also stop on click outside container (registered once)
    document.body.addEventListener('click', function(e) {
      if (scrollActive && !timerEl.contains(e.target) && !document.getElementById('slideNav').contains(e.target)) {
        stopScroll();
      }
    }, true);

    // SCROLL WHEEL (registered once)
    window.addEventListener('wheel', function() {
      if (scrollActive) stopScroll();
    }, { passive: true });

    // WINDOW BLUR (registered once)
    window.addEventListener('blur', function() {
      if (scrollActive) stopScroll();
    });

    // TIMER (registered once)
    timerEl.addEventListener('click', function(e) {
      e.stopPropagation();
      if (timerRunning) {
        clearInterval(timerInterval);
        timerInterval = null;
        timerRunning = false;
        timerEl.classList.remove('running');
      } else {
        if (timerDisplay.textContent === '00:00') {
          timerStart = Date.now();
        } else {
          var parts = timerDisplay.textContent.split(':');
          var elapsed = parseInt(parts[0]) * 60000 + parseInt(parts[1]) * 1000;
          timerStart = Date.now() - elapsed;
        }
        timerRunning = true;
        timerEl.classList.add('running');
        timerInterval = setInterval(function() {
          var elapsed = Date.now() - timerStart;
          var mins = Math.floor(elapsed / 60000);
          var secs = Math.floor((elapsed % 60000) / 1000);
          timerDisplay.textContent =
            String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
        }, 250);
      }
    });

    timerEl.addEventListener('dblclick', function() {
      clearInterval(timerInterval);
      timerInterval = null;
      timerRunning = false;
      timerEl.classList.remove('running');
      timerDisplay.textContent = '00:00';
    });

    // SCROLL-BASED PROGRESS (registered once)
    window.addEventListener('scroll', function() {
      var maxScroll = document.documentElement.scrollHeight - window.innerHeight;
      if (maxScroll > 0) {
        var pct = (window.scrollY / maxScroll) * 100;
        progressFill.style.width = pct + '%';
      }
    }, { passive: true });

    // Initial DOM query + IntersectionObserver setup
    refreshTeleprompter();
  }

  // ============================================================
  // SETTINGS PANEL
  // ============================================================

  (function initSettings() {
    var savedTheme = localStorage.getItem('gp-theme') || 'night';
    var savedAccent = localStorage.getItem('gp-accent') || 'gold';

    document.documentElement.dataset.theme = savedTheme;
    document.documentElement.dataset.accent = savedAccent;

    // Check matching radio inputs
    var themeRadio = document.querySelector('input[name="theme"][value="' + savedTheme + '"]');
    if (themeRadio) themeRadio.checked = true;

    var accentRadio = document.querySelector('input[name="accent"][value="' + savedAccent + '"]');
    if (accentRadio) accentRadio.checked = true;

    // Theme radio change
    document.querySelectorAll('input[name="theme"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        document.documentElement.dataset.theme = radio.value;
        localStorage.setItem('gp-theme', radio.value);
      });
    });

    // Accent radio change
    document.querySelectorAll('input[name="accent"]').forEach(function(radio) {
      radio.addEventListener('change', function() {
        document.documentElement.dataset.accent = radio.value;
        localStorage.setItem('gp-accent', radio.value);
      });
    });

    // Toggle settings panel
    var settingsBtn = document.getElementById('settingsBtn');
    var settingsPanel = document.getElementById('settingsPanel');

    settingsBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      settingsPanel.classList.toggle('visible');
    });

    // Click outside panel -> close
    document.addEventListener('click', function(e) {
      if (!settingsPanel.contains(e.target) && e.target !== settingsBtn) {
        settingsPanel.classList.remove('visible');
      }
    });
  })();

})();
</script>

</body>
</html>
